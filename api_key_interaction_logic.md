# API 密钥管理 PRD 文档

**创建日期**: 2026-01-21
**更新日期**: 2026-02-03

## 变更记录
| 日期       | 版本  | 变更内容                                                       | 修改人      |
| ---------- | ----- | -------------------------------------------------------------- | ----------- |
| 2026-01-21 | 1.x.x | 初始迭代版本（定义生成逻辑、增加授权流程、补全 IP 白名单细节） | Antigravity |
| 2026-01-21 | 2.0.0 | 重构版本：优化目录结构，修正编号冲突，统一业务逻辑与技术细节   | Antigravity |
| 2026-02-03 | 3.0.0 | 架构升级：IP 白名单从全局模式改为 API Key 关联模式，新增复制功能 | AI Assistant |
| 2026-02-03 | 3.1.0 | UI/UX优化：重新设计密钥创建流程，强调上传公钥为主要操作，现代化界面设计 | AI Assistant |

---

## 1. 业务概述与目标
商户平台提供 API 密钥管理功能，用于商户在集成 PICA API 时进行身份验证和签名校验（双向签名机制）。
- **核心原则**：安全第一，兼顾效率。采用“数据不落手”准则处理敏感密钥。
- **业务目标**：通过引导式交互防止私钥丢失，通过多重授权防止越权操作，通过批量 IP 处理提升开发效率。

## 2. 全局通用规则
- **配额限制**：每个商户账号最多允许创建 **2** 个 API 密钥。当达到上限时，系统自动隐藏“创建密钥”按钮。
- **生效机制**：所有创建、更新、禁用、删除及白名单变更操作在后端均为 **立即生效**。
- **持久化原则**：仅在通过“安全授权”并获得后端成功响应后，操作方可持久化到数据库。关闭未保存弹窗将导致内存中暂存的数据物理销毁。

---

## 3. 核心功能：API 密钥创建
密钥创建提供两种并行路径，通过 `Segmented` (分段控制器) 进行强制性路径决策。

### 3.1 路径决策阶段
- **交互组件**：采用 `Segmented` 替代 `Tabs` 增强“二选一”的决策感。
- **引导文案**：显式提示“请选择公钥提供方式”。

### 3.2 路径 A：上传公钥
- **输入方式**：支持拖拽文件上传 (`.pem`, `.pub`) 或文本粘贴。
- **校验逻辑**：
    - 强制校验 **PKCS8 PEM** 格式。
    - 仅支持 **RSA 2048** 或 **RSA 4096** 长度。

### 3.3 路径 B：生成新密钥对 (浏览器端生成)
- **生成规格**：支持 RSA 2048 / 4096 (推荐)。
- **安全强制链**：
    1. **私钥保存**：必须点击“下载私钥”或“复制”，否则“备份确认”复选框禁用。
    2. **备份确认**：必须手动勾选承诺，方可开启“直接上传公钥”按钮。
- **视觉增强**：采用 **Side-by-Side (双列)** 紧凑布局，并辅以自动滚动 (Auto-scroll) 聚焦结果。
- **防丢处理**：未备份即尝试关闭弹窗时，触发二次确认拦截。

### 3.4 创建成功反馈
- **展示内容**：成功图标、安全提醒（PICA 不存储私钥）、“商户公钥上传成功”状态确认。
- **平台公钥交付**：弹窗内直接提供平台公钥下载，文件名为 `pica_platform_public_key_[keyId].pem`。

---

## 4. 核心功能：密钥列表管理

### 4.1 列表展示项
- **核心字段**：API Key ID、状态标签、商户公钥指纹 (显示前 16 位)、平台公钥下载入口、创建时间。
- **交互行为**：悬浮展示详细信息。

### 4.2 状态管理 (禁用/启用)
- **风险提示**：执行操作前弹出确认 Modal，说明状态变更对现有业务的影响。
- **安全拦截**：操作必须通过 PIN 码/安全授权。

### 4.3 密钥删除
- **物理删除**：确认删除后，该密钥记录从服务端永久移除，不可恢复。
- **操作权重**：最高级操作，需经过二次确认 Modal + 安全授权。

### 4.4 列表缺省态
- 当未创建任何密钥时，展示 “暂无 API 密钥” 的图标引导。

---

## 5. 专项：IP 白名单管理 (v3.0 架构升级)

### 5.0 架构变更概述
**从全局模式升级为 API Key 关联模式**：
- **旧架构 (v2.0)**：所有 API Keys 共享一个全局白名单
- **新架构 (v3.0)**：每个 API Key 独立管理自己的白名单
- **UI 布局**：白名单直接内嵌在每个 API Key 卡片内部，采用 `Collapse` 折叠面板展示
- **复制功能**：新增白名单复制功能，支持在多个 Keys 之间复制配置

### 5.1 生效模式 (核心逻辑)
- **开放模式**：单个 Key 的白名单为空时，允许 **所有 IP** 使用该 Key 访问。
- **白名单模式**：一旦某个 Key 存在白名单记录，**仅允许** 列表内 IP 使用该 Key 访问。
- **独立性原则 (v3.0)**：不同 API Keys 的白名单完全独立，互不影响。

### 5.2 批量录入交互
- **输入组件**：采用文本域 (`TextArea`) 支持批量粘贴。
- **分隔符**：支持 **逗号 (,)**、**空格**、**换行**。
- **识别反馈**：实时显示“识别到 X 个项”。

### 5.3 校验与去重逻辑
- **格式支持**：IPv4、IPv6、CIDR (如 192.168.1.0/24)。
- **去重处理**：自动过滤输入中的重复项，并检查与现有白名单的冲突。
- **汇总清单**：批量提交后弹出“成功/跳过”详情模态框。

### 5.4 列表展示与删除逻辑
- **展示**：表格化展示，包含 IP 地址、类型及添加时间。
- **删除**：点击行末图标，通过 `Popconfirm` (局部气泡) 进行二次确认，立即生效。
- **独立管理 (v3.0)**：每个 Key 的白名单在其自己的卡片内独立显示和管理。

### 5.5 白名单复制功能 (v3.0 新增)
**功能描述**：支持将一个 API Key 的白名单快速复制到其他 Keys。

**触发入口**：
- 在每个 API Key 卡片的白名单区域提供"复制白名单到其他 Key"按钮
- 仅当存在多个 API Keys 时显示该按钮

**复制流程**：
1. **选择目标**：弹出 `CopyWhitelistModal`，显示其他可用的 API Keys（排除当前 Key）
2. **多选支持**：支持同时选择多个目标 Keys，使用 Checkbox 组件
3. **冲突策略**：提供两种复制模式
   - **覆盖模式**：清空目标 Key 的现有白名单，完全替换为源白名单
   - **合并模式**：将源白名单追加到目标 Key，自动去重
4. **预览确认**：显示源白名单的 IP 数量和部分内容，目标 Keys 显示当前 IP 数量
5. **批量执行**：确认后批量更新所有选中的目标 Keys
6. **结果反馈**：显示成功复制到 X 个 Keys 的提示消息

**应用场景**：
- 新建 Key 后快速复制已有的白名单配置
- 统一管理多个环境的白名单（如测试环境、生产环境）
- 批量配置相同的访问控制策略

---

## 6. 安全授权体系 (Security Gate)

### 6.1 授权触发点
以下操作必须通过 `AuthorizationModal` 进行二次身份验证：
- **Create**：提交商户公钥。
- **Toggle**：禁用或启用密钥。
- **Delete**：删除密钥。

### 6.2 后端校验原则
- **Token 校验**：所有敏感 API 请求必须携带授权产生的加密 Token。
- **会话绑定**：后端严格校验 Token、当前登录 Session 与操作目标的归属关系。

---

## 7. 技术架构与后端交互

### 7.1 密钥角色
- **商户端**：私钥签名请求，公钥交平台验签。
- **平台端**：私钥签名响应，公钥交商户下载验签。

### 7.2 核心数据流
1.  **采集**：前端获取商户公钥。
2.  **指纹**：后端（而非前端）负责计算 SHA256 指纹以确保存储一致性。
3.  **生成**：后端实时生成对应的平台密钥对。
4.  **存储**： merchant/platform 公钥及加密后的平台私钥存入数据库。

### 7.3 数据生命周期
- **Zero-Knowledge**：商户私钥仅在浏览器内存（Blob URL）存在，不进入前后端协议字段。
- **清理机制**：前端 React 状态随弹窗销毁而重置，防止敏感信息在页面间残留。

---

## 8. 交互设计原则：资源 vs 属性
系统根据影响范围划分交互形态：
- **资源级操作 (Entity Level)**：影响密钥整体生命周期的操作，使用 **居中遮罩 Modal**。
  - 示例：创建 Key、删除 Key、禁用/启用 Key、复制白名单（跨 Key 操作）
- **属性级操作 (Attribute Level)**：影响局部配置的操作，使用 **按钮旁 Popconfirm 气泡** 或 **内嵌 Modal**。
  - 示例：删除单个 IP（Popconfirm）、添加 IP（Modal）
- **集成展示原则 (v3.0)**：白名单作为 Key 的子属性，内嵌在 Key 卡片中，保持层级关系清晰。

---

## 9. 安全性补充
- **防暴力破解**：PIN 码错误次数达到上限将锁定授权能力。
- **环境一致性**：白名单变更实时推送到 API Gateway 缓存。
- **独立隔离 (v3.0)**：每个 API Key 的白名单独立生效，避免误操作影响其他 Keys。
- **复制审计 (v3.0)**：白名单复制操作建议记录到审计日志，便于追溯配置变更历史。

---

## 10. 技术实现说明 (v3.0)

### 10.1 组件架构
- **APIKeyCard**：封装单个 API Key 的完整展示和管理，包含白名单子区域
- **IPWhitelistList**：纯列表展示组件，负责渲染 IP 表格和删除操作
- **IPInputModal**：独立的添加 IP Modal，可在多个 Key 间复用
- **CopyWhitelistModal**：白名单复制功能的专用 Modal，支持多选和冲突策略

### 10.2 数据模型
```typescript
interface ApiKey {
    keyId: string;
    // ... 其他字段
    ipWhitelist?: IPWhitelistEntry[]; // 每个 Key 独立的白名单数组
}
```

### 10.3 状态管理
- **更新单个 Key 的白名单**：通过 `keyId` 精确定位，避免影响其他 Keys
- **复制逻辑**：根据冲突策略（覆盖/合并）批量更新多个目标 Keys
- **去重机制**：合并模式下自动过滤重复 IP（不区分大小写）

### 10.4 国际化支持
新增翻译 Keys：
- `dashboard.developer.api_keys.whitelist.copy_to_other_keys`
- `dashboard.developer.api_keys.whitelist.copy_modal_title`
- `dashboard.developer.api_keys.whitelist.copy_success`
- `dashboard.developer.api_keys.whitelist.conflict_options.overwrite`
- `dashboard.developer.api_keys.whitelist.conflict_options.merge`
- `dashboard.developer.api_keys.success_modal.configure_whitelist`
- `dashboard.developer.api_keys.success_modal.configure_later`
- `dashboard.developer.api_keys.success_modal.whitelist_hint`
- `dashboard.developer.api_keys.success_modal.whitelist_hint_desc`
